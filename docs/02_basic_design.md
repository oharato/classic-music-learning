# 基本設計書 - クラシック音楽学習アプリ

## 1. 設計概要

### 1.1. 目的
本ドキュメントは、「クラシック音楽学習アプリ」のシステム設計を定義するものである。要件定義書に基づき、機能、データ構造、システム構成を明確にする。

### 1.2. システム構成
*   **フロントエンド**: Vue.js (SPA: Single Page Application)
    *   UIの描画、ユーザー操作の受付、バックエンドAPIとの通信を担当する。
*   **バックエンド**: Hono (Cloudflare Pages Functions)
    *   ランキングデータの永続化と提供のためのAPIサーバーとして機能する。
*   **データベース**: Cloudflare D1 (SQLite)
    *   ランキングデータを保存する軽量なデータベース。

## 2. 機能詳細設計

### 2.1. データ構造
#### 2.1.1. 楽曲データ
アプリケーション内で使用する楽曲に関する情報は、フロントエンド側にJSONファイルとして保持する。
`public/music.ja.json` (日本語版) および `public/music.en.json` (英語版)
```json
[
  {
    "id": "symphony_5_beethoven",
    "title": "交響曲第5番「運命」",
    "composer": "ベートーヴェン",
    "genre": "交響曲",
    "audio_url": "https://upload.wikimedia.org/wikipedia/commons/...",
    "description": "ベートーヴェンの交響曲第5番ハ短調作品67は...",
    "trivia": "冒頭の4つの音は「運命がドアを叩く音」と..."
  },
  // ... 他の楽曲データ
]
```

#### 2.1.2. ランキングデータ (DBテーブル)
`ranking_daily` テーブル (日次ランキング)
| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | INTEGER | 主キー (自動採番) |
| `nickname` | TEXT | ユーザーニックネーム |
| `score` | INTEGER | スコア |
| `region` | TEXT | 出題範囲（作曲家カテゴリ） |
| `format` | TEXT | クイズ形式 |
| `date` | TEXT | 日付 |
| `created_at` | TEXT | 登録日時 (ISO 8601形式) |

`ranking_all_time` テーブル (全期間ランキング)
| カラム名 | 型 | 説明 |
| :--- | :--- | :--- |
| `id` | INTEGER | 主キー (自動採番) |
| `nickname` | TEXT | ユーザーニックネーム |
| `score` | INTEGER | ベストスコア |
| `region` | TEXT | 出題範囲（作曲家カテゴリ） |
| `format` | TEXT | クイズ形式 |
| `created_at` | TEXT | 初回登録日時 |
| `updated_at` | TEXT | スコア更新日時 |

### 2.2. 機能ごとのロジック
#### 2.2.1. クイズモード
*   **問題生成ロジック**:
    *   出題する問題は、`music.ja.json` または `music.en.json` から指定した条件（作曲家など）でフィルタリングし、ランダムに重複なく選出する。
    *   各問題の選択肢（4択）は、正解の1つと、不正解の3つ（同じJSONファイルからランダムに選出）で構成する。不正解の選択肢は、正解と重複しないようにする。
*   **スコア計算**:
    *   要件定義通り `スコア = (正解数 * 1000) - (回答時間[秒] * 10)` とする。
    *   時間はクイズ開始から最終問題の回答完了までの秒単位の時間とする。

#### 2.2.2. ランキング機能
*   **登録**: クイズ完了後、結果画面でニックネームと算出されたスコアをバックエンドAPIに送信し、DBに登録する。
*   **表示**: ランキング画面表示時、バックエンドAPIから上位100件のランキングデータを取得して表示する。
*   **順位付け**: `score` の降順（高い順）で順位を決定する。スコアが同点の場合は、`created_at` の昇順（登録が早い順）で上位とする。

#### 2.2.3. 学習モード
*   **表示ロジック**:
    *   `music.ja.json` または `music.en.json` のデータをリストとして読み込む。
    *   「次へ」「前へ」ボタンで、リストのインデックスを移動し、対応する楽曲の情報を表示する。
*   **クイズ形式の選択**:
    *   **曲→曲名モード**: カードの表面には音声プレーヤー、裏面には曲名やその他の詳細情報を表示する。
    *   **曲名→作曲家モード**: カードの表面には曲名やその他の詳細情報、裏面には作曲家名を表示する。
    *   クリックまたはタップでカードが回転するアニメーションを実装する。
*   **楽曲一覧**: カード下部に楽曲のタイトル一覧を表示し、クリックで直接その楽曲に移動できる。

## 3. UI/UX設計

### 3.1. レスポンシブデザイン
#### 3.1.1. モバイルファースト設計
*   スマートフォンでの使用を最優先し、その後PCサイズに拡張する設計方針
*   Tailwind CSSのブレークポイント（`md:`以上）を活用

#### 3.1.2. 適応的レイアウト
*   **フォームコンポーネント**:
    *   スマホ: コンパクトなパディング（`px-2 py-1.5`）とフォントサイズ（`text-sm`）
    *   PC: 標準サイズ（`px-3 py-2`）とフォントサイズ（`text-base`）
*   **ランキング表示**:
    *   PC: テーブル形式で全情報を横並び表示
    *   スマホ: カード形式で情報を縦並びに表示し、視認性を向上
*   **ラベル表示の最適化**:
    *   ランキング画面: スマホではラベルを非表示にしてスペースを節約
    *   クイズ設定画面: 全画面サイズでラベルを表示してフォームの明確性を確保

### 3.2. ユーザーフィードバック
#### 3.2.1. バリデーションエラー表示
*   **従来の問題**: alertダイアログによる強制的な中断
*   **改善策**:
    *   入力欄の下にエラーメッセージを赤文字で表示
    *   入力欄の枠線を赤色に変更して視覚的フィードバック
    *   ユーザーが入力を開始すると自動的にエラーをクリア
*   **利点**: 画面遷移なしにエラー内容を確認でき、スムーズな修正が可能

#### 3.2.2. ローディング状態の表示
*   統一されたLoadingSpinnerコンポーネントによる視覚的フィードバック
*   サイズとメッセージのカスタマイズが可能

### 3.3. コンポーネント設計
*   **DRY原則の徹底**: 共通機能を再利用可能コンポーネントとして実装
*   **統一されたUI**: AppButtonコンポーネントによるボタンスタイルの統一
*   **保守性の向上**: コンポーネント単位でのスタイル変更が可能

### 3.4. 音声再生
*   HTMLの `<audio>` タグを使用した音声再生
*   再生/一時停止ボタンによる操作
*   スペースキーでの再生/一時停止のショートカット
